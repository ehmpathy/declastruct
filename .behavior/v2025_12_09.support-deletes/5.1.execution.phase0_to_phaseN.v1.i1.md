# Execution Log: Declarative Delete Support

## Phase 0: Foundation

### 0.1 Create `DECLASTRUCT_DELETE` symbol
- [x] Create `src/domain/symbols.ts`
- [x] Define symbol export

**Status:** COMPLETE

**Verification:**
```
npm run test:types # passed
```

---

## Phase 1: Core Implementation

### 1.1 Create `del()` and `isMarkedForDeletion()` helpers
- [x] Create directory `src/domain.operations/del/`
- [x] Create `src/domain.operations/del/del.ts`
- [x] Implement `del<T extends DeclaredResource>(resource: T): T & { [DECLASTRUCT_DELETE]: true }`
- [x] Implement `isMarkedForDeletion<T extends DeclaredResource>(resource: T): resource is T & { [DECLASTRUCT_DELETE]: true }`

**Status:** COMPLETE

**Verification:**
```
npm run test:types # passed
```

### 1.2 Create unit tests for `del()` helpers
- [x] Create `src/domain.operations/del/del.test.ts`
- [x] Test: `del()` marks resource for deletion
- [x] Test: `del()` preserves original resource properties
- [x] Test: `isMarkedForDeletion()` returns false for unmarked resources
- [x] Test: `del()` is idempotent

**Status:** COMPLETE

**Verification:**
```
npm run test:unit -- src/domain.operations/del/del.test.ts
# 7 tests passed
```

---

## Phase 2: Integration with Planning

### 2.1 Update `planChanges.ts` to detect deletion markers
- [x] Import `isMarkedForDeletion` from `../../domain.operations/del/del`
- [x] Before `computeChange()`, check if resource is marked for deletion
- [x] If marked, pass `desired: null` to `computeChange()`

**Status:** COMPLETE

**Verification:**
```
npm run test:integration -- src/domain.operations/plan/planChanges
# 9 tests passed (7 existing + 2 new)
```

### 2.2 Add integration test for `del()` in planChanges
- [x] Add test: resource marked with `del()` produces `DESTROY` action
- [x] Add test: `state.desired` is `null` for deleted resources
- [x] Add test: diff is present for deleted resources

**Status:** COMPLETE

---

## Phase 3: SDK Export

### 3.1 Export `del` and `isMarkedForDeletion` from SDK
- [x] Update `src/contract/sdk/index.ts`
- [x] Add export: `export { del, isMarkedForDeletion } from '../../domain.operations/del/del';`

**Status:** COMPLETE

**Verification:**
```
npm run test:types # passed
```

---

## Phase 4: CLI Integration Tests

### 4.1 Create test fixture templates
- [x] Create `src/.test/assets/wish-for-del.fixture.ts` with placeholder `__TEST_EXID__`
- [x] Create `src/.test/assets/wish-with-del.fixture.ts` with placeholder `__TEST_EXID__` and `del()` wrapper
- [x] Use dynamic require with absolute paths for portability when cloned

**Status:** COMPLETE

### 4.2 Add `cloneFixtureWithExid` test helper
- [x] Add helper to `src/contract/cli/plan.integration.test.ts`
- [x] Add helper to `src/contract/cli/apply.integration.test.ts`

**Status:** COMPLETE

### 4.3 Add plan CLI integration test for `del()`
- [x] Add test: setup resource → plan with `del()` → verify `DESTROY` action

**Status:** COMPLETE

**Verification:**
```
npm run test:integration -- src/contract/cli/plan.integration.test.ts
# 8 tests passed (7 existing + 1 new)
```

### 4.4 Add apply CLI integration test for `del()`
- [x] Add test: setup resource → apply deletion → verify resource is gone

**Status:** COMPLETE

### 4.5 Add yolo mode integration test for `del()`
- [x] Add test: setup in yolo → delete in yolo → verify `DESTROY` logged

**Status:** COMPLETE

**Verification:**
```
npm run test:integration -- src/contract/cli/apply.integration.test.ts
# 16 tests passed (14 existing + 2 new)
```

---

## Phase 5: Final Verification

### 5.1 Run full test suite
- [x] Run all unit tests
- [x] Run all integration tests
- [x] Run type checks
- [x] Run lint checks
- [x] Run format checks

**Status:** COMPLETE

**Verification:**
```
THOROUGH=true npm run test
# 56 tests passed, 6 test suites
# Types: passed
# Lint: passed
# Format: passed
# Build: passed
```

### 5.2 Manual smoke test
- [ ] Pending user verification

---

## Summary

All automated phases complete. The `del()` feature is implemented and tested:

**Files Created:**
- `src/domain/symbols.ts` - DECLASTRUCT_DELETE symbol
- `src/domain.operations/del/del.ts` - del() and isMarkedForDeletion()
- `src/domain.operations/del/del.test.ts` - unit tests
- `src/.test/assets/wish-for-del.fixture.ts` - test fixture template
- `src/.test/assets/wish-with-del.fixture.ts` - test fixture template with del()

**Files Modified:**
- `src/domain.operations/plan/planChanges.ts` - detect deletion markers
- `src/domain.operations/plan/planChanges.integration.test.ts` - del() tests
- `src/contract/sdk/index.ts` - export del and isMarkedForDeletion
- `src/contract/cli/plan.integration.test.ts` - del() CLI test
- `src/contract/cli/apply.integration.test.ts` - del() CLI tests

**Usage:**
```ts
import { del } from 'declastruct';

const getResources = async () => {
  const tokens = await getAllIamAuthTokens(...);
  return tokens.map(token => del(token)); // mark all for deletion
};
```
