# Roadmap: Declarative Delete Support

## Phase 0: Foundation

### 0.1 Create `DECLASTRUCT_DELETE` symbol
- [ ] Create `src/domain/symbols.ts`
- [ ] Define `export const DECLASTRUCT_DELETE = Symbol.for('declastruct.delete');`

**Acceptance Criteria:**
- File exists at `src/domain/symbols.ts`
- Symbol is exported and can be imported

**Verification:**
```bash
npx tsc --noEmit src/domain/symbols.ts
```

---

## Phase 1: Core Implementation

### 1.1 Create `del()` and `isMarkedForDeletion()` helpers
- [ ] Create directory `src/domain.operations/del/`
- [ ] Create `src/domain.operations/del/del.ts`
- [ ] Implement `del<T extends DeclaredResource>(resource: T): T & { [DECLASTRUCT_DELETE]: true }`
- [ ] Implement `isMarkedForDeletion<T extends DeclaredResource>(resource: T): resource is T & { [DECLASTRUCT_DELETE]: true }`

**Dependencies:** 0.1

**Acceptance Criteria:**
- `del()` returns resource with symbol property set to `true`
- `isMarkedForDeletion()` returns `true` for marked resources
- `isMarkedForDeletion()` returns `false` for unmarked resources
- TypeScript compiles without errors

**Verification:**
```bash
npx tsc --noEmit src/domain.operations/del/del.ts
```

### 1.2 Create unit tests for `del()` helpers
- [ ] Create `src/domain.operations/del/del.test.ts`
- [ ] Test: `del()` marks resource for deletion
- [ ] Test: `del()` preserves original resource properties
- [ ] Test: `isMarkedForDeletion()` returns false for unmarked resources
- [ ] Test: `del()` is idempotent (`del(del(resource))` works)

**Dependencies:** 1.1

**Acceptance Criteria:**
- All unit tests pass
- Coverage for both `del()` and `isMarkedForDeletion()`

**Verification:**
```bash
npm run test:unit -- src/domain.operations/del/del.test.ts
```

---

## Phase 2: Integration with Planning

### 2.1 Update `planChanges.ts` to detect deletion markers
- [ ] Import `isMarkedForDeletion` from `../../domain.operations/del/del`
- [ ] Before `computeChange()`, check if resource is marked for deletion
- [ ] If marked, pass `desired: null` to `computeChange()`

**Dependencies:** 1.1

**Acceptance Criteria:**
- Resources marked with `del()` produce `DESTROY` action in plan
- Unmarked resources behave as before (CREATE/UPDATE/KEEP)
- No regression in existing tests

**Verification:**
```bash
npm run test:unit -- src/domain.operations/plan/planChanges
npm run test:integration -- src/domain.operations/plan/planChanges
```

### 2.2 Add integration test for `del()` in planChanges
- [ ] Add test to `src/domain.operations/plan/planChanges.integration.test.ts`
- [ ] Test: resource marked with `del()` produces `DESTROY` action
- [ ] Test: `state.desired` is `null` for deleted resources
- [ ] Test: `state.remote` contains the existing resource

**Dependencies:** 2.1

**Acceptance Criteria:**
- Integration test passes
- Verifies full flow from `del()` → `planChanges()` → `DESTROY`

**Verification:**
```bash
npm run test:integration -- src/domain.operations/plan/planChanges
```

---

## Phase 3: SDK Export

### 3.1 Export `del` and `isMarkedForDeletion` from SDK
- [ ] Update `src/contract/sdk/index.ts`
- [ ] Add export: `export { del, isMarkedForDeletion } from '../../domain.operations/del/del';`

**Dependencies:** 1.1

**Acceptance Criteria:**
- `del` and `isMarkedForDeletion` are importable from `declastruct`
- TypeScript compiles without errors

**Verification:**
```bash
npx tsc --noEmit
```

---

## Phase 4: CLI Integration Tests

### 4.1 Create test fixture templates
- [ ] Create `src/.test/assets/wish-for-del.fixture.ts` with placeholder `__TEST_EXID__`
- [ ] Create `src/.test/assets/wish-with-del.fixture.ts` with placeholder `__TEST_EXID__` and `del()` wrapper

**Dependencies:** 3.1

**Acceptance Criteria:**
- Both fixtures compile without errors
- Fixtures use `__TEST_EXID__` placeholder for test isolation

**Verification:**
```bash
npx tsc --noEmit src/.test/assets/wish-for-del.fixture.ts
npx tsc --noEmit src/.test/assets/wish-with-del.fixture.ts
```

### 4.2 Add `cloneFixtureWithExid` test helper
- [ ] Add helper function to clone fixtures with unique exid
- [ ] Helper reads fixture, replaces `__TEST_EXID__` with uuid, writes to temp dir

**Dependencies:** 4.1

**Acceptance Criteria:**
- Helper produces valid TypeScript files in temp directory
- Placeholder is correctly replaced with provided exid

**Verification:**
- Manual inspection or inline test

### 4.3 Add plan CLI integration test for `del()`
- [ ] Add test to `src/contract/cli/plan.integration.test.ts`
- [ ] Test: setup resource → plan with `del()` → verify `DESTROY` action

**Dependencies:** 4.2

**Acceptance Criteria:**
- Test creates resource, then plans deletion
- Plan shows `DESTROY` action with `desired: null`

**Verification:**
```bash
npm run test:integration -- src/contract/cli/plan.integration.test.ts
```

### 4.4 Add apply CLI integration test for `del()`
- [ ] Add test to `src/contract/cli/apply.integration.test.ts`
- [ ] Test: setup resource → apply deletion → verify resource is gone (CREATE on re-plan)

**Dependencies:** 4.2

**Acceptance Criteria:**
- Test creates resource, deletes it, verifies it's gone
- Re-planning shows `CREATE` (resource no longer exists)

**Verification:**
```bash
npm run test:integration -- src/contract/cli/apply.integration.test.ts
```

### 4.5 Add yolo mode integration test for `del()`
- [ ] Add test to `src/contract/cli/apply.integration.test.ts`
- [ ] Test: setup resource in yolo → delete in yolo → verify `DESTROY` logged

**Dependencies:** 4.2

**Acceptance Criteria:**
- Test works in yolo mode (no plan file)
- Console output includes `DESTROY`

**Verification:**
```bash
npm run test:integration -- src/contract/cli/apply.integration.test.ts
```

---

## Phase 5: Final Verification

### 5.1 Run full test suite
- [ ] Run all unit tests
- [ ] Run all integration tests
- [ ] Run type checks

**Dependencies:** 4.3, 4.4, 4.5

**Acceptance Criteria:**
- All tests pass
- No TypeScript errors
- No regressions

**Verification:**
```bash
npm run test
npx tsc --noEmit
```

### 5.2 Manual smoke test
- [ ] Create a wish file using `del()`
- [ ] Run `declastruct plan`
- [ ] Verify `DESTROY` action in plan output
- [ ] Run `declastruct apply`
- [ ] Verify resource is deleted

**Dependencies:** 5.1

**Acceptance Criteria:**
- End-to-end flow works as expected
- User-facing output is clear and correct

**Verification:**
- Manual execution and visual inspection

---

## Summary Checklist

```
Phase 0: Foundation
  [ ] 0.1 Create DECLASTRUCT_DELETE symbol

Phase 1: Core Implementation
  [ ] 1.1 Create del() and isMarkedForDeletion() helpers
  [ ] 1.2 Create unit tests for del() helpers

Phase 2: Integration with Planning
  [ ] 2.1 Update planChanges.ts to detect deletion markers
  [ ] 2.2 Add integration test for del() in planChanges

Phase 3: SDK Export
  [ ] 3.1 Export del and isMarkedForDeletion from SDK

Phase 4: CLI Integration Tests
  [ ] 4.1 Create test fixture templates
  [ ] 4.2 Add cloneFixtureWithExid test helper
  [ ] 4.3 Add plan CLI integration test for del()
  [ ] 4.4 Add apply CLI integration test for del()
  [ ] 4.5 Add yolo mode integration test for del()

Phase 5: Final Verification
  [ ] 5.1 Run full test suite
  [ ] 5.2 Manual smoke test
```
