# Execution: getRef Convenience Methods for DeclastructDao

## Phase 1: Interface Breaking Change

### 1.1 Update DeclastructDao Interface
- [ ] add `dobj: TResourceClass` attribute to interface
- [ ] restructure `get` from flat methods to `get.one` namespace
- [ ] add `get.ref` namespace with `byPrimary` and `byUnique` (type: `fn | null`)
- [ ] add `.what` and `.why` jsdoc comments to all operations

### 1.2 Update DeclastructDao Type Tests
- [ ] add type test: missing `dobj` fails with `@ts-expect-error`
- [ ] add type test: old flat `get.byUnique` structure fails with `@ts-expect-error`
- [ ] add type test: new `get.one` structure compiles

### 1.3 Update Existing Dao Usages
- [ ] search codebase for `dao.get.byUnique` → update to `dao.get.one.byUnique`
- [ ] search codebase for `dao.get.byPrimary` → update to `dao.get.one.byPrimary`
- [ ] search codebase for `dao.get.byRef` → update to `dao.get.one.byRef`
- [ ] add `dobj` to all dao instantiations

---

## Phase 2: Core Utilities

### 2.1 Implement getRefByPrimary
- [ ] create `src/domain.operations/ref/getRefByPrimary.ts`
- [ ] implement logic: if already RefByPrimary, return as-is
- [ ] implement logic: if RefByUnique, fetch via `dao.get.one.byUnique` and extract primary
- [ ] implement logic: throw `UnexpectedCodePathError` for invalid ref
- [ ] throw `BadRequestError` when resource not found

### 2.2 Add getRefByPrimary Unit Tests
- [ ] create `src/domain.operations/ref/getRefByPrimary.test.ts`
- [ ] test: RefByPrimary input returns as-is without db call
- [ ] test: RefByUnique input fetches resource and returns primary key
- [ ] test: RefByUnique input throws BadRequestError if not found
- [ ] type test: output is `RefByPrimary` (has uuid, not externalId)
- [ ] type test: dao for resource fits context shape

### 2.3 Implement getRefByUnique
- [ ] create `src/domain.operations/ref/getRefByUnique.ts`
- [ ] implement logic: if already RefByUnique, return as-is
- [ ] implement logic: if RefByPrimary, fetch via `dao.get.one.byPrimary` and extract unique
- [ ] implement logic: throw `UnexpectedCodePathError` for invalid ref
- [ ] throw `BadRequestError` when resource not found

### 2.4 Add getRefByUnique Unit Tests
- [ ] create `src/domain.operations/ref/getRefByUnique.test.ts`
- [ ] test: RefByUnique input returns as-is without db call
- [ ] test: RefByPrimary input fetches resource and returns unique key
- [ ] test: RefByPrimary input throws BadRequestError if not found
- [ ] type test: output is `RefByUnique` (has externalId, not uuid)
- [ ] type test: dao for resource fits context shape

### 2.5 Update SDK Exports
- [ ] add `getRefByPrimary` export to `src/contract/sdk/index.ts`
- [ ] add `getRefByUnique` export to `src/contract/sdk/index.ts`

---

## Phase 3: Validation

### 3.1 Run Full Test Suite
- [ ] run all tests: types, unit, integration, acceptance

### 3.2 Build Package
- [ ] build package
- [ ] verify no build errors

