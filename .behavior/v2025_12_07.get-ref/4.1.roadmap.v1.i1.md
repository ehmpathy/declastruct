# Roadmap: getRef Convenience Methods for DeclastructDao

## Phase 1: Interface Breaking Change

### 1.1 Update DeclastructDao Interface
- [ ] add `dobj: TResourceClass` attribute to interface
- [ ] restructure `get` from flat methods to `get.one` namespace
- [ ] add `get.ref` namespace with `byPrimary` and `byUnique` (type: `fn | null`)
- [ ] add `.what` and `.why` jsdoc comments to all operations

**depends on**: nothing

**acceptance criteria**:
- `DeclastructDao` interface requires `dobj` attribute
- `dao.get.one.byUnique`, `dao.get.one.byPrimary`, `dao.get.one.byRef` exist
- `dao.get.one.byPrimary` and `dao.get.ref.*` use `fn | null` type (forces explicit decision)
- all operations have `.what` and `.why` comments

**verification**:
```sh
npm run test:types
```

---

### 1.2 Update DeclastructDao Type Tests
- [ ] add type test: missing `dobj` fails with `@ts-expect-error`
- [ ] add type test: old flat `get.byUnique` structure fails with `@ts-expect-error`
- [ ] add type test: new `get.one` structure compiles

**depends on**: 1.1

**acceptance criteria**:
- type tests verify `dobj` is required
- type tests verify old flat structure is rejected
- type tests verify new nested structure is accepted

**verification**:
```sh
npm run test:unit -- DeclastructDao
```

---

### 1.3 Update Existing Dao Usages
- [ ] search codebase for `dao.get.byUnique` → update to `dao.get.one.byUnique`
- [ ] search codebase for `dao.get.byPrimary` → update to `dao.get.one.byPrimary`
- [ ] search codebase for `dao.get.byRef` → update to `dao.get.one.byRef`
- [ ] add `dobj` to all dao instantiations

**depends on**: 1.1

**acceptance criteria**:
- no usages of old flat `dao.get.byUnique` pattern remain
- all dao instantiations include `dobj` attribute

**verification**:
```sh
# should find zero matches
grep -r "dao\.get\.byUnique\|dao\.get\.byPrimary\|dao\.get\.byRef" src/ --include="*.ts" | grep -v "dao\.get\.one\." | grep -v "dao\.get\.ref\."

npm run test:types
npm run test:unit
```

---

## Phase 2: Core Utilities

### 2.1 Implement getRefByPrimary
- [ ] create `src/domain.operations/ref/getRefByPrimary.ts`
- [ ] implement logic: if already RefByPrimary, return as-is
- [ ] implement logic: if RefByUnique, fetch via `dao.get.one.byUnique` and extract primary
- [ ] implement logic: throw `UnexpectedCodePathError` for invalid ref
- [ ] throw `BadRequestError` when resource not found

**depends on**: 1.1

**acceptance criteria**:
- returns input unchanged if already `RefByPrimary`
- fetches resource and extracts primary key if `RefByUnique`
- throws `BadRequestError` if resource not found via unique key
- throws `UnexpectedCodePathError` for invalid ref type

**verification**:
```sh
npm run test:types
```

---

### 2.2 Add getRefByPrimary Unit Tests
- [ ] create `src/domain.operations/ref/getRefByPrimary.test.ts`
- [ ] test: RefByPrimary input returns as-is without db call
- [ ] test: RefByUnique input fetches resource and returns primary key
- [ ] test: RefByUnique input throws BadRequestError if not found
- [ ] type test: output is `RefByPrimary` (has uuid, not externalId)
- [ ] type test: dao for resource fits context shape

**depends on**: 2.1

**acceptance criteria**:
- all unit tests pass
- type tests verify output shape

**verification**:
```sh
npm run test:unit -- getRefByPrimary
```

---

### 2.3 Implement getRefByUnique
- [ ] create `src/domain.operations/ref/getRefByUnique.ts`
- [ ] implement logic: if already RefByUnique, return as-is
- [ ] implement logic: if RefByPrimary, fetch via `dao.get.one.byPrimary` and extract unique
- [ ] implement logic: throw `UnexpectedCodePathError` for invalid ref
- [ ] throw `BadRequestError` when resource not found

**depends on**: 1.1

**acceptance criteria**:
- returns input unchanged if already `RefByUnique`
- fetches resource and extracts unique key if `RefByPrimary`
- throws `BadRequestError` if resource not found via primary key
- throws `UnexpectedCodePathError` for invalid ref type

**verification**:
```sh
npm run test:types
```

---

### 2.4 Add getRefByUnique Unit Tests
- [ ] create `src/domain.operations/ref/getRefByUnique.test.ts`
- [ ] test: RefByUnique input returns as-is without db call
- [ ] test: RefByPrimary input fetches resource and returns unique key
- [ ] test: RefByPrimary input throws BadRequestError if not found
- [ ] type test: output is `RefByUnique` (has externalId, not uuid)
- [ ] type test: dao for resource fits context shape

**depends on**: 2.3

**acceptance criteria**:
- all unit tests pass
- type tests verify output shape

**verification**:
```sh
npm run test:unit -- getRefByUnique
```

---

### 2.5 Update SDK Exports
- [ ] add `getRefByPrimary` export to `src/contract/sdk/index.ts`
- [ ] add `getRefByUnique` export to `src/contract/sdk/index.ts`

**depends on**: 2.1, 2.3

**acceptance criteria**:
- both utilities are exported from sdk
- consumers can `import { getRefByPrimary, getRefByUnique } from 'declastruct'`

**verification**:
```sh
npm run build
# check dist/contract/sdk/index.d.ts contains exports
```

---

## Phase 3: Validation

### 3.1 Run Full Test Suite
- [ ] run all tests: types, unit, integration, acceptance

**depends on**: 2.2, 2.4, 2.5

**acceptance criteria**:
- all tests pass
- no regressions

**verification**:
```sh
npm run test
```

---

### 3.2 Build Package
- [ ] build package
- [ ] verify no build errors

**depends on**: 3.1

**acceptance criteria**:
- package builds successfully
- dist/ contains expected outputs

**verification**:
```sh
npm run build
ls dist/domain.operations/ref/
```

---

## Summary

| Phase | Steps | Dependencies |
|-------|-------|--------------|
| 1. Interface Breaking Change | 1.1, 1.2, 1.3 | - |
| 2. Core Utilities | 2.1, 2.2, 2.3, 2.4, 2.5 | Phase 1 |
| 3. Validation | 3.1, 3.2 | Phase 2 |
